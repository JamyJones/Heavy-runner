name: TRANSLATE JAVA_GUIDE

on:
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Generate matrix dynamically
        id: generate
        run: |
          # Generate a JSON array of chunk IDs (1 to 100)
          MATRIX=$(seq 10 90 | jq -c '[inputs]')
          echo "::set-output name=matrix::$MATRIX"

  translate-the-guide:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chunk_id: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout private tools
        uses: actions/checkout@v4
        with:
          repository: john4650-hub/Hello-Android-CI
          token: ${{ secrets.TK }}
      - name: install ffmpeg
        uses: animMouse/setup-ffmpeg@v1
      - name: install deps
        run: |
          pipx install mdformat > log.txt
          pipx inject mdformat mdformat-gfm mdformat-frontmatter mdformat-footnote mdformat-gfm-alerts >log.txt
          pip install argostranslate >log.txt
          pip install -U g4f[all] >log.txt

      - name: Get java guide repository
        run: |
          git clone https://github.com/Snailclimb/JavaGuide
          find ./JavaGuide -type f -name "README.md" > doc_files.txt
          split -n l/90  --numeric-suffixes=11 --suffix-length=2  doc_files.txt chunk_
      - name: Running heavy process Here
        run: |
          chmod +x run_command.sh
          ./run_command.sh 0.${{ github.run_number }}.0 $GITHUB_TOKEN chunk_${{ matrix.chunk_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.TK }}
        shell: bash
      - name: Upload modifications
        uses: actions/upload-artifact@v4
        with:
          name: modified-files-${{ matrix.chunk_id }}
          path: ./out
          retention-days: 1
  Combine-all-changes:
    needs: translate-the-guide
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./workspace
          #name: modified-files-${{ matrix.chunk_id }}

      - name: Merge all changes
        run: |
          git clone https://github.com/Snailclimb/JavaGuide
          for dir in workspace/modified-files-*/; do
            cp -r "$dir"* .
          done
          cd JavaGuide
          git remote remove origin
          git remote add origin 'https://github.com/john4650-hub/JavaGuide.git'
          git remote set-url origin "https://john4650-hub:$GITHUB_TOKEN@github.com/john4650-hub/JavaGuide.git"
          git config --global user.name "john4650-hub"
          git config --global user.email "johndelvin51@gmail.com"
          git config --global --add safe.directory "$(pwd)"
          git add .
          git commit -m "Push changes"
          git push -f --set-upstream origin main
        env:
          GITHUB_TOKEN: ${{ secrets.TK }}
        shell: bash

