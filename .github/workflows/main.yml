name: DOWNLOAD MANGA CHAPTERS

on:
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Checkout Files
        uses: actions/checkout@v4
        with:
          repository: john4650-hub/Hello-Android-CI
          token: ${{ secrets.TK }}

      - name: Generate matrix dynamically
        id: generate
        run: |
          chapters=()
          # Loop through each key in mangaDownloader.json
          for mKey in $(jq -r 'keys[]' configs/mangaDownloader.json); do
          echo $mKey
            range=$(jq -r --arg key "$mKey" '.[$key].chapter_range' configs/mangaDownloader.json)
            IFS='-' read -r start end <<< "$range"
            for chapter in $(seq "$start" "$end"); do
              chapters+=("\"$mKey-$chapter\"")
            done
          done
          # Compose as a JSON array
          echo "matrix=[$(IFS=,; echo "${chapters[*]}")]"
          echo "matrix=[$(IFS=,; echo "${chapters[*]}")]" >> $GITHUB_OUTPUT

  Get-Manga:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chunk_id: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout private tools
        uses: actions/checkout@v4
        with:
          repository: john4650-hub/Hello-Android-CI
          token: ${{ secrets.TK }}

      - name: install ffmpeg
        uses: animMouse/setup-ffmpeg@v1

      - name: install deps
        run: |
          sudo apt-get update
          sudo apt-get install imagemagick -y
          sudo apt-get install pdftk -y
          pip install bs4 requests selenium webdriver-manager

      - name: Prepare Chapter
        run: |
          chmod +x scripts/*.sh
          # Parse chunk_id to get mKey and chapter
          mkey=$(echo "${{ matrix.chunk_id }}" | cut -d '-' -f 1)
          chapter=$(echo "${{ matrix.chunk_id }}" | cut -d '-' -f 2)
          # Get range for safety, not strictly necessary unless needed by your script
          range=$(jq -r --arg key "$mkey" '.[$key].chapter_range' configs/mangaDownloader.json)
          IFS='-' read -r start end <<< "$range"
          ./scripts/generate_sed_file.sh "$start" "$end" "$mkey"
          ls

      - name: Running heavy process Here
        run: ./scripts/imageMagic.sh 0.${{ github.run_number }}.0 $GITHUB_TOKEN sed_${{ matrix.chunk_id }}.sh ${{ matrix.chunk_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.TK }}
        shell: bash
      - name: List files
        run: ls *.pdf
